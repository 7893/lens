# 存储体系与数据生命周期管理 (02-DATABASE-STORAGE)

Lens 的存储架构建立在“职责分离 (Separation of Concerns)”的核心原则之上。我们并没有使用单一的数据库，而是将系统状态散布在四个互补的 Cloudflare 存储组件中：D1 负责关系型元数据，R2 负责二进制大对象，Vectorize 负责语义坐标，KV 负责热数据缓存与全局配置。

---

## 1. D1 数据库：关系型状态核心

D1 (基于 SQLite) 是系统的“单一事实来源 (Single Source of Truth)”。它不仅存储图片的基础信息，还充当了分布式采集引擎的“记事本”。

### 1.1 `images` 表：旗舰版数据模型

该表的设计目标是支持复杂的 AI 元数据存储与高性能的画廊翻页。

- **身份标记 (ID)**：采用 Unsplash 原始 ID，这不仅是主键，也是关联 R2 文件和外部 API 的唯一指纹。
- **物理属性**：存储 `width` 和 `height` 的初衷是为了让前端在图片加载出来之前，就能通过 `aspect-ratio` 预留出完美的占位高度，彻底消除瀑布流加载时的抖动。
- **AI 进化字段**：
  - `ai_model`：记录该记录是由哪个“大脑”产生的。通过这个字段，系统能精准识别出哪些是 3.2 版本的“技术债”，并交给进化引擎处理。
  - `ai_quality_score`：一个 0.0 到 10.0 的浮动值。它打破了传统搜索“只有相关性”的局限，让系统能够优先向用户推送那些高美学质量的视觉大片。
  - `entities_json`：利用 Llama 4 提取的地标、品牌、物种等结构化标签。这为未来的“按实体筛选”功能预留了无限的扩展空间。

### 1.2 `system_config` 表：分布式的“播放进度条”

通过 `last_seen_id` 和 `backfill_next_page`，D1 将一个每小时运行一次的瞬时任务，串联成了一个具备“记忆”能力的持久化流水线。无论 Worker 部署多少次，系统都能接上之前的断点继续采集。

---

## 2. R2 存储：分层资产战略

R2 作为 S3 兼容的存储桶，不仅解决了图片的物理存放问题，还通过分层策略大幅降低了 AI 处理的内存压力。

### 2.1 路径解耦与用途

系统在 R2 中严格区分了两个命名空间：

1.  **`raw/` (存档层)**：存储 Unsplash 的最高分辨率原图。虽然 AI 分析不需要这么高的精度，但它是保证用户下载体验的基石。
2.  **`display/` (生产层)**：存储优化后的 Regular 画质图（1080p 左右）。
    - **核心逻辑**：AI Vision 模型 (Llama 4) 会直接读取该路径下的字节流。由于 Llama 4 会将图片切片，使用 Regular 画质既能保证 AI 看清细节，又不会因为文件过大导致 Worker 超出 128MB 的内存红线。

### 2.2 Immutable 缓存代理

由于 R2 的 Class B 操作是有配额限制的，API 实现了一个智能代理层。当用户访问图片时，API 会计算 `ETag` 并在 Header 中注入 `cache-control: public, max-age=31536000, immutable`。这使得图片一旦进入 Cloudflare 的边缘缓存，就再也不会产生 R2 的读取费。

---

## 3. Vectorize：语义维度的物理映射

Vectorize 是 Lens 搜索引擎的“物理索引”。它存储的是由 BGE-M3 产生的 1024 维向量。

- **降维增效**：虽然模型支持更高维度的表达，但系统目前统一锁定在 1024 维，这是平衡召回率与计算延迟的最佳甜点位。
- **Metadata 注入**：为了减少“搜索 -> D1 捞数据 -> 返回”的数据库往返，我们在 Vectorize 的每一个 Vector 旁都冗余存储了 `url` 和 `caption`。这意味着对于简单的列表页展示，系统在完成向量检索的一瞬间，就已经拿到了渲染前端所需的所有基础素材。

---

## 4. KV (SETTINGS)：动态配置与计费模拟器

KV 承担了系统中最不守规矩、更新最频繁的数据。

### 4.1 离线 Neuron 计费器

由于 Cloudflare 内部无法直接实时查询 Neurons 余额，KV 扮演了“离线水表”的角色。

- **原子计数**：每天生成一个形如 `stats:neurons:2026-02-22` 的 Key。
- **策略约束**：每次 Workflow 成功入库一张新图，就会增加一个预设的 Neurons 权重值。
- **进化触发**：当 `getTodayRemainingNeurons` 函数被调用时，它会读取该水表，计算出今天还能挥霍多少 Neurons，从而决定自进化循环的刷新规模。

### 4.2 语义缓存层

存储了“用户原始搜索词”到“AI 扩展后语义词”的映射。它的存在让 Llama 4 这种重量级模型在面对高频请求时，表现得像静态配置一样迅速。
